<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="data.mapper.PlanMapper">
	<select id="getCityCode" parameterType="int" resultType="Map">
		select name as city_name, area_code, sigungu_code from city where num=#{cityNum}
	</select>
	<select id="getMyPlaceList" parameterType="Map" resultType="place">
		select * from `like`, place where `like`.place_id=place.contentid and place.city_num=#{city_num} and `check`=1 and member_num=#{member_num}
	</select>
	<insert id="insertTrip" parameterType="trip">
		insert into trip (member_num, city_num, start_date, end_date, days) 
		values (#{memberNum}, #{cityNum}, #{startDate}, #{endDate}, #{days}) 
		<selectKey resultType="int" keyProperty="num" order="AFTER">
    	select max(num) from trip
    </selectKey>
	</insert>
	<insert id="insertItinerary" parameterType="itinerary">
		insert into itinerary (trip_num, `day`, `order`, place_id) values (#{trip_num}, #{day}, #{order}, #{place_id})
	</insert>
	<select id="checkPlace" parameterType="String" resultType="int">
		select count(*) from place where contentid=#{contentid}
	</select>
	<insert id="insertPlace" parameterType="place">
		insert into place values 
		(#{city_num}, #{contentid}, #{contenttypeid}, #{title}, #{cat3}, #{addr1}, #{addr2}, #{firstimage}, #{mapx}, #{mapy})
	</insert>
	
	<!-- 일정 수정 페이지 -->
	<select id="getTripInfo" parameterType="int" resultType="citytrip">
		select trip.num as tripNum, trip.name as tripName, member_num as memberNum, city_num as cityNum, start_date as startDate, end_date as endDate, days, city.name as cityName, area_code, sigungu_code, x, y 
		from trip, city where city_num=city.num and trip.num=#{tripNum}
	</select>
	
<!--                                                -->

	<select id="getNavNum" resultType="plan">
		select * from itinerary, place where trip_num=#{num} and place_id=contentid group by `day` order by `day`;
	</select>

	<select id="getPlanDatas" parameterType="int" resultType="plan">
		select * from (select num, trip_num, day, `order`, place_id, contentid, city_num, cat2_name, mapx, mapy, image, `name`, firstimage, `type`, title, place.cat3, cat3_name from itinerary, place, service_type_code, city where trip_num=#{num} and place_id=contentid and place.cat3 = service_type_code.cat3 and place.city_num = city.num order by `day`, `order`) main left outer join (select place_id, truncate(avg(stars), 2) as avg_star from review group by place_id) stars on main.place_id = stars.place_id;
	</select>
	
	<select id="getDate" parameterType="int" resultType="pdate">
		SELECT * FROM final_project.trip, city where city_num=city.num and trip.num=#{num};
	</select>
	
	<select id="getPlanMember" parameterType="int" resultType="pdate">
		SELECT * FROM final_project.trip, member where member.num=member_num and trip.num=#{num};
	</select>
	<select id="mapKakao" parameterType="int" resultType="planMap">
		SELECT `day`, `order`, mapx, mapy FROM itinerary, place where place_id = contentid and trip_num=#{num} order by `day`, `order`;
	</select>
</mapper>